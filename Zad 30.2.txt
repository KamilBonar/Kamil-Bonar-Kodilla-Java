ALTER TABLE BOOKS ADD COLUMN BESTSELLER BOOLEAN NULL;

DROP PROCEDURE IF EXISTS UpdateBestsellers;

DELIMITER $$

CREATE PROCEDURE UpdateBestsellers()
BEGIN
    DECLARE BOOKS_NUMBER, BKS_ID INT DEFAULT 0;
    DECLARE IS_BESTSELLER BOOLEAN;
    DECLARE FINISHED INT DEFAULT 0;
    DECLARE ALL_BOOKS CURSOR FOR SELECT BOOK_ID FROM RENTS;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET FINISHED = 1;
    OPEN ALL_BOOKS;
    WHILE (FINISHED = 0) DO
            FETCH ALL_BOOKS INTO BKS_ID;
            IF (FINISHED = 0) THEN
                SELECT COUNT(*) FROM RENTS
                WHERE BOOK_ID = BKS_ID
                INTO BOOKS_NUMBER;
                IF (BOOKS_NUMBER > 2) THEN
                    SET IS_BESTSELLER = TRUE;
                ELSE
                    SET IS_BESTSELLER = FALSE;
                END IF;
                UPDATE BOOKS SET BESTSELLER = IS_BESTSELLER
                WHERE BOOK_ID = BKS_ID;
                COMMIT;
            END IF;
        END WHILE;
    CLOSE ALL_BOOKS;
END $$

DELIMITER ;

CALL UpdateBestsellers();